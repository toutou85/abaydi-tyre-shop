<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>عبايدي للعجلات — القائمة</title>
  <style>
    body { font-family: 'Tajawal', Arial, sans-serif; background:#f2f2f2; margin:0; padding:20px; }
    header { background:#007bff; color:#fff; padding:12px 16px; border-radius:6px; margin-bottom:14px; text-align:center; font-size:1.2rem; }
    .searchBox { width:100%; max-width:1100px; margin:0 auto 16px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center; }
    label { font-size:0.95rem; margin-right:6px; }
    select, button { padding:8px 10px; font-size:1rem; border:1px solid #ccc; border-radius:6px; background:#fff; }
    button { background:#28a745; color:#fff; border:none; cursor:pointer; }
    table { width:100%; max-width:1100px; margin:10px auto 40px; border-collapse:collapse; background:#fff; box-shadow:0 4px 18px rgba(0,0,0,0.06); border-radius:8px; overflow:hidden; }
    th, td { padding:12px; text-align:center; border-bottom:1px solid #eee; }
    th { background:#007bff; color:#fff; }
    tr:nth-child(even) td { background:#fafafa; }
    .info { text-align:center; margin-top:10px; color:#666; }
    @media (max-width:700px){
      .searchBox{flex-direction:column; gap:6px;}
      select, button{width:100%;}
    }
  </style>
</head>
<body>

  <header>🛞 متجر عبايدي للعجلات — القائمة</header>

  <div class="searchBox">
    <div>
      <label for="width">العرض</label>
      <select id="width">
        <option value="">الكل</option>
        <option>125</option>
        <option>135</option>
        <option>145</option>
        <option>155</option>
        <option>165</option>
        <option>175</option>
        <option>185</option>
        <option>195</option>
        <option>205</option>
        <option>215</option>
        <option>225</option>
        <option>235</option>
        <option>245</option>
        <option>255</option>
        <option>265</option>
        <option>275</option>
        <option>285</option>
        <option>295</option>
        <option>305</option>
        <option>315</option>
      </select>
    </div>

    <div>
      <label for="aspect">النسبة (الارتفاع)</label>
      <select id="aspect">
        <option value="">الكل</option>
        <option>25</option>
        <option>30</option>
        <option>35</option>
        <option>40</option>
        <option>45</option>
        <option>50</option>
        <option>55</option>
        <option>60</option>
        <option>65</option>
        <option>70</option>
        <option>75</option>
        <option>80</option>
        <option>85</option>
      </select>
    </div>

    <div>
      <label for="diameter">القطر</label>
      <select id="diameter">
        <option value="">الكل</option>
        <option>10</option>
        <option>11</option>
        <option>12</option>
        <option>13</option>
        <option>14</option>
        <option>15</option>
        <option>16</option>
        <option>17</option>
        <option>18</option>
        <option>19</option>
        <option>20</option>
        <option>21</option>
        <option>22</option>
        <option>23</option>
        <option>24</option>
      </select>
    </div>

    <div>
      <button id="searchBtn">🔍 تطبيق الفلتر</button>
    </div>
  </div>

  <table aria-live="polite">
    <thead>
      <tr>
        <th>المقاس</th>
        <th>السعر (دج)</th>
        <th>الكمية</th>
      </tr>
    </thead>
    <tbody id="productsBody">
      <tr><td colspan="3">جاري التحميل...</td></tr>
    </tbody>
  </table>

  <div class="info">إذا كان في مقاس ما تريده مش ظاهر، تقدر تحدث قائمة المنتجات في Google Sheets أو ترسللي مثال على اسم منتج مفقود.</div>

<script>
  // رابط Google Sheets (CSV منشور)
  const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBz1iucjkuwAG78fd6m1zE4oXKuaZzlgVGO7cK1uts7UkTFgT0nxpqXA-ovj8iOa9FhujqCSpxHrXw/pub?output=csv";

  const body = document.getElementById("productsBody");
  const widthSelect = document.getElementById("width");
  const aspectSelect = document.getElementById("aspect");
  const diameterSelect = document.getElementById("diameter");
  const searchBtn = document.getElementById("searchBtn");

  let products = [];

  // دالة بسيطة لفك CSV مع دعم للحقول الموضوعية "quoted"
  function parseCSV(text){
    text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const rows = [];
    let cur = '';
    let row = [];
    let inQuotes = false;
    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      if (ch === '"') {
        // إذا التالي " أيضاً فنسجله كـ "
        if (inQuotes && text[i+1] === '"') {
          cur += '"';
          i++; // تخطي الثاني
        } else {
          inQuotes = !inQuotes;
        }
      } else if (ch === ',' && !inQuotes) {
        row.push(cur);
        cur = '';
      } else if (ch === '\n' && !inQuotes) {
        row.push(cur);
        rows.push(row);
        row = [];
        cur = '';
      } else {
        cur += ch;
      }
    }
    // باقي الحقل
    if (cur !== '' || row.length) {
      row.push(cur);
      rows.push(row);
    }
    // فلترة الأسطر الفارغة
    return rows.filter(r => r.length > 1 || (r.length===1 && r[0].trim() !== ''));
  }

  // تطبيع النص: نحذف المسافات و الشرطات و الشرط المائل باش نقارن بسهولة، و نحول للحروف الكبيرة
  function normalize(str){
    return String(str || '').toUpperCase().replace(/\s+|\/|-|-/g, '');
  }

  // جلب و معالجة البيانات
  fetch(sheetUrl)
    .then(r => {
      if (!r.ok) throw new Error('خطأ في جلب الملف من Google Sheets');
      return r.text();
    })
    .then(text => {
      const rows = parseCSV(text);
      // نفترض الصف الأول رؤوس: نأخذ الباقي
      const dataRows = rows.slice(1);
      products = dataRows.map(cols => {
        // افتراض: العمود 0 = fullName ، 1 = price ، 2 = qty
        return {
          fullName: (cols[0] || '').trim(),
          price: (cols[1] || '').trim(),
          qty: (cols[2] || '').trim()
        };
      }).filter(p => p.fullName); // نلغي الصفوف الفارغة
      displayProducts(products);
    })
    .catch(err => {
      body.innerHTML = `<tr><td colspan="3" style="color:red">حدث خطأ في تحميل المنتجات: ${err.message}</td></tr>`;
      console.error(err);
    });

  // عرض المنتجات في الجدول
  function displayProducts(list){
    if (!list || list.length === 0) {
      body.innerHTML = `<tr><td colspan="3">🚫 لا توجد منتجات متاحة</td></tr>`;
      return;
    }
    body.innerHTML = '';
    for (const p of list) {
      const price = p.price || '-';
      const qty = p.qty || '-';
      body.innerHTML += `<tr>
        <td>${escapeHtml(p.fullName)}</td>
        <td>${escapeHtml(price)}</td>
        <td>${escapeHtml(qty)}</td>
      </tr>`;
    }
  }

  // فلترة مع تطبيع النص لتفادي المسافات والشرطات
  function filterProducts(){
    const w = widthSelect.value.trim();
    const a = aspectSelect.value.trim();
    const d = diameterSelect.value.trim();

    let filtered = products.slice();

    if (w) {
      const normW = normalize(w);
      filtered = filtered.filter(p => normalize(p.fullName).includes(normW));
    }
    if (a) {
      const normA = normalize(a);
      filtered = filtered.filter(p => normalize(p.fullName).includes(normA));
    }
    if (d) {
      const normD = 'R' + String(d).toUpperCase();
      filtered = filtered.filter(p => normalize(p.fullName).includes(normD));
    }

    displayProducts(filtered);
  }

  // استدعاء الفلتر عند الضغط على الزر أو عند تغيير أي select (اختياري أن يعمل فوري)
  searchBtn.addEventListener('click', filterProducts);
  widthSelect.addEventListener('change', filterProducts);
  aspectSelect.addEventListener('change', filterProducts);
  diameterSelect.addEventListener('change', filterProducts);

  // دالة لحماية عرض HTML نصي
  function escapeHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }
</script>

</body>
</html>